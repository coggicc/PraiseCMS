@using PraiseCMS.Shared.Methods
@model PraiseCMS.DataAccess.Models.ManageLayoutVM

@{
    ViewBag.Title = $"Manage {Model.DashboardTemplate.Name} Dashboard";

    var mockDashboard = new DashboardViewModel
    {
        Notifications = new List<Notification>(),
        PrayerRequests = new List<PrayerRequest>(),
        Payments = new List<Payment>(),
        OfflineGiving = new List<OfflineGiving>()
    };

    var note = new Notification
    {
        Name = "Prayer request follow-up",
        CreatedDate = DateTime.Now,
        Viewed = false
    };
    var note2 = new Notification
    {
        Name = "Schedule quarterly baptisms.",
        CreatedDate = DateTime.Now.AddDays(-7),
        Viewed = false
    };
    var note3 = new Notification
    {
        Name = "Order new choir robes.",
        CreatedDate = DateTime.Now.AddDays(-25),
        Viewed = false
    };
    mockDashboard.Notifications.Add(note);
    mockDashboard.Notifications.Add(note2);
    mockDashboard.Notifications.Add(note3);

    var prayerRequest = new PrayerRequest
    {
        Message = "Dear frozen yogurt, you are the celery of desserts. Be ice cream, or be nothing.",
        CreatedDate = DateTime.Now,
        Archived = false
    };
    var prayerRequest2 = new PrayerRequest
    {
        Message = "I've been quite open about this around the office: I don't want this parks department to build any parks because I don't believe in government. I think that all government is a waste of taxpayer money. My dream is to have the park system privatized and run entirely by for-profit corporations, like Chuck E. Cheese. They have an impeccable business model. I would rather work for Chuck E. Cheese.",
        CreatedDate = DateTime.Now.AddDays(-7),
        Archived = false
    };
    var prayerRequest3 = new PrayerRequest
    {
        Message = "If I keep my body moving, and my mind occupied at all times, I will avoid falling into a bottomless pit of despair.",
        CreatedDate = DateTime.Now.AddDays(-15),
        Archived = false
    };
    var prayerRequest4 = new PrayerRequest
    {
        Message = "You know what they say about a car wreck, where it's so awful you can't look away? The Dundies are like a car wreck that you want to look away from, but you have to stare at it because your boss is making you.",
        CreatedDate = DateTime.Now,
        Archived = false,
        Confidential = true
    };
    var prayerRequest5 = new PrayerRequest
    {
        Message = "Well, this is what happened. Uh, Ryan's big project was the website, which wasn't doing so well. So Ryan, to give the impression of sales, recorded them twice. Once as offices and once in the website sales, which is what we refer to in the business as misleading the shareholders. Another good term is fraud. The real crime, I think, was the beard.",
        CreatedDate = DateTime.Now.AddDays(-7),
        Archived = false,
        Confidential = true
    };
    var prayerRequest6 = new PrayerRequest
    {
        Message = "Guess what, I have flaws. What are they? Oh, I don't know. I sing in the shower. Sometimes I spend too much time volunteering. Occasionally I'll hit somebody with my car. So sue me.",
        CreatedDate = DateTime.Now.AddDays(-15),
        Archived = false,
        Confidential = true
    };
    var prayerRequest7 = new PrayerRequest
    {
        Message = "The raccoon problem is under control. They have their part of the town and we have ours.",
        CreatedDate = DateTime.Now,
        Archived = false,
        HighPriority = true
    };
    var prayerRequest8 = new PrayerRequest
    {
        Message = "Everything hurts and I'm dyin.",
        CreatedDate = DateTime.Now.AddDays(-7),
        Archived = false,
        HighPriority = true
    };
    var prayerRequest9 = new PrayerRequest
    {
        Message = "If I don't have some cake soon, I might die.",
        CreatedDate = DateTime.Now.AddDays(-15),
        Archived = false,
        HighPriority = true
    };
    mockDashboard.PrayerRequests.Add(prayerRequest);
    mockDashboard.PrayerRequests.Add(prayerRequest2);
    mockDashboard.PrayerRequests.Add(prayerRequest3);
    mockDashboard.PrayerRequests.Add(prayerRequest4);
    mockDashboard.PrayerRequests.Add(prayerRequest5);
    mockDashboard.PrayerRequests.Add(prayerRequest6);
    mockDashboard.PrayerRequests.Add(prayerRequest7);
    mockDashboard.PrayerRequests.Add(prayerRequest8);
    mockDashboard.PrayerRequests.Add(prayerRequest9);
}

@*<style type="text/css">
        ul {
            list-style-type: none;
        }

        #widgetsSorting .card.sort-handle {
            flex: unset;
            float: left;
            border: 0;
            user-select: none;
        }

        #widgetsSorting .sortable-placeholder {
            margin: 40px 40px 0px 0px !important;
            background-color: silver;
            max-width: 46% !important;
            flex: 40% !important;
            box-shadow: 1px 1px 6px 0px #ddd;
            height: 180px;
            list-style-type: none;
        }

        #widgetsSorting {
            padding: 0px 0px 0px 43px;
            width: 100%;
            margin: 0px auto;
        }

        .ui-sortable-handle:hover {
            cursor: grab;
        }

        #tileWidgetsSorting .sortable-placeholder {
            background-color: silver !important;
            max-width: 15% !important;
            flex: 15% !important;
            margin: 0 1rem;
        }

        #tileWidgetsSorting .kt-portlet, #widgetsSorting .kt-portlet {
            margin: 1rem 1rem;
            box-shadow: 1px 1px 6px 0px #ddd;
            display: inline-table;
        }

        #widgetsSorting .card-title {
            margin-bottom: 0;
        }
    </style>*@

@if (SessionVariables.CurrentUser.IsAdmin || SessionVariables.CurrentUser.IsSuperAdmin)
{
    @section subheader{
        <div class="d-flex align-items-center">
            <a href="/dashboardtemplates" class="btn btn-light-primary btn-sm mr-2">Dashboard Templates</a>
        </div>
    }
}

<div class="alert alert-custom alert-white alert-shadow fade show gutter-b" role="alert">
    <div class="alert-icon">
        <span class="svg-icon svg-icon-primary svg-icon-xl">
            <!--begin::Svg Icon | path:assets/media/svg/icons/Tools/Compass.svg-->
            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24px" height="24px" viewBox="0 0 24 24" version="1.1">
                <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                    <rect x="0" y="0" width="24" height="24"></rect>
                    <path d="M7.07744993,12.3040451 C7.72444571,13.0716094 8.54044565,13.6920474 9.46808594,14.1079953 L5,23 L4.5,18 L7.07744993,12.3040451 Z M14.5865511,14.2597864 C15.5319561,13.9019016 16.375416,13.3366121 17.0614026,12.6194459 L19.5,18 L19,23 L14.5865511,14.2597864 Z M12,3.55271368e-14 C12.8284271,3.53749572e-14 13.5,0.671572875 13.5,1.5 L13.5,4 L10.5,4 L10.5,1.5 C10.5,0.671572875 11.1715729,3.56793164e-14 12,3.55271368e-14 Z" fill="#000000" opacity="0.3"></path>
                    <path d="M12,10 C13.1045695,10 14,9.1045695 14,8 C14,6.8954305 13.1045695,6 12,6 C10.8954305,6 10,6.8954305 10,8 C10,9.1045695 10.8954305,10 12,10 Z M12,13 C9.23857625,13 7,10.7614237 7,8 C7,5.23857625 9.23857625,3 12,3 C14.7614237,3 17,5.23857625 17,8 C17,10.7614237 14.7614237,13 12,13 Z" fill="#000000" fill-rule="nonzero"></path>
                </g>
            </svg>
            <!--end::Svg Icon-->
        </span>
    </div>
    <div class="alert-text"><b>Tiled Widgets</b> Drag the tiles in the order in which you want them to display. These will display as tiles in the top row of the dashboard.</div>
</div>

<div class="row">
    @foreach (var item in Model.TileWidgetSortable.Where(item => item.Widget.IsNotNullOrEmpty()))
    {
        if (item.Widget.ImageUrl.IsNotNullOrEmpty())
        {
            <div class="@(!string.IsNullOrEmpty(item.Widget.LayoutSize) ? item.Widget.LayoutSize : "col-md-6 col-lg-6 col-xl-3" ) draggable-zone">
                <!--begin::Card-->
                <div class="card card-custom gutter-b draggable" id="@item.Widget.Id" data-location="Top">
                    <div class="card-header">
                        <div class="card-title">
                            <h3 class="card-label">@item.Widget.Name</h3>
                        </div>
                        <div class="card-toolbar">
                            <a href="#" class="btn btn-icon btn-sm btn-hover-light-primary draggable-handle">
                                <i class="ki ki-menu"></i>
                            </a>
                        </div>
                    </div>
                    <div class="card-body">
                        <img src="@Html.Raw("Upload.Images".AppSetting<string>("/Uploads"))/@item.Widget.ImageUrl" class="img-fluid" />
                    </div>
                </div>
                <!--end::Card-->
            </div>
        }
    }
</div>

@*<div class="card card-custom gutter-b">
        <div class="card-header">
            <div class="card-title">
                <h3 class="card-title align-items-start flex-column">
                    <span class="card-label font-weight-bolder text-dark">Tiled Widgets</span>
                    <span class="text-muted mt-3 font-weight-bold font-size-sm">Drag the tiles in the order in which you want them to display.</span>
                </h3>
            </div>
        </div>
        <div class="card-body">
            <p>These will display as tiles in the top row of the dashboard.</p>
            <ul id="tileWidgetsSorting" class="widgetsSorting card-group">
                @foreach (var item in Model.TileWidgetSortable.Where(item => item.Widget.IsNotNull()))
                {
                    if (item.Widget.ImageUrl.IsNotNullOrEmpty())
                    {
                        <li id="@item.Widget.Id" data-location="Top" class="kt-portlet sort-handle">
                            <img src="@Html.Raw("Upload.Images".AppSetting<string>("/Uploads"))/@item.Widget.ImageUrl" class="img-fluid" />
                        </li>
                    }
                    else
                    {
                        if (item.Widget.FileName.IsNotNullOrEmpty())
                        {
                            <li id="@item.Widget.Id" data-location="Top" class="kt-portlet card sort-handle">
                                <div class="card-header">
                                    <h3 class="card-title font-weight-bolder">@item.Widget.Name</h3>
                                </div>
                                <div class="card-body p-1">
                                    <div data-scroll="true" data-height="300">
                                        @try
                                        {
                                            Html.RenderAction(Path.GetFileNameWithoutExtension(item.Widget.FileName), "Home", new { name = item.Widget.FileName });
                                        }
                                        catch (Exception ex)
                                        {
                                            ExceptionLogger.LogException(ex);
                                            @Html.Partial(item.Widget.FileName.WidgetPartialViewUrl(), mockDashboard)
                                        }
                                    </div>
                                </div>
                            </li>
                        }
                    }
                }
            </ul>
        </div>
    </div>*@

<div class="alert alert-custom alert-white alert-shadow fade show gutter-b" role="alert">
    <div class="alert-icon">
        <span class="svg-icon svg-icon-primary svg-icon-xl">
            <!--begin::Svg Icon | path:assets/media/svg/icons/Tools/Compass.svg-->
            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24px" height="24px" viewBox="0 0 24 24" version="1.1">
                <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                    <rect x="0" y="0" width="24" height="24"></rect>
                    <path d="M7.07744993,12.3040451 C7.72444571,13.0716094 8.54044565,13.6920474 9.46808594,14.1079953 L5,23 L4.5,18 L7.07744993,12.3040451 Z M14.5865511,14.2597864 C15.5319561,13.9019016 16.375416,13.3366121 17.0614026,12.6194459 L19.5,18 L19,23 L14.5865511,14.2597864 Z M12,3.55271368e-14 C12.8284271,3.53749572e-14 13.5,0.671572875 13.5,1.5 L13.5,4 L10.5,4 L10.5,1.5 C10.5,0.671572875 11.1715729,3.56793164e-14 12,3.55271368e-14 Z" fill="#000000" opacity="0.3"></path>
                    <path d="M12,10 C13.1045695,10 14,9.1045695 14,8 C14,6.8954305 13.1045695,6 12,6 C10.8954305,6 10,6.8954305 10,8 C10,9.1045695 10.8954305,10 12,10 Z M12,13 C9.23857625,13 7,10.7614237 7,8 C7,5.23857625 9.23857625,3 12,3 C14.7614237,3 17,5.23857625 17,8 C17,10.7614237 14.7614237,13 12,13 Z" fill="#000000" fill-rule="nonzero"></path>
                </g>
            </svg>
            <!--end::Svg Icon-->
        </span>
    </div>
    <div class="alert-text"><b>Dashboard Widgets</b> Drag the widgets in the order in which you want them to display. These will display just below the top row tiles.</div>
</div>

<div class="row">
    @foreach (var item in Model.MainWidgetSortable.Where(item => item.Widget.IsNotNullOrEmpty()))
    {
        if (item.Widget.ImageUrl.IsNotNullOrEmpty())
        {
            <div class="@(!string.IsNullOrEmpty(item.Widget.LayoutSize) ? item.Widget.LayoutSize : "col-md-6 col-lg-6 col-xl-3" ) draggable-zone">
                <!--begin::Card-->
                <div class="card card-custom gutter-b draggable" id="@item.Widget.Id" data-location="Main">
                    <div class="card-header">
                        <div class="card-title">
                            <h3 class="card-label">@item.Widget.Name</h3>
                        </div>
                        <div class="card-toolbar">
                            <a href="#" class="btn btn-icon btn-sm btn-hover-light-primary draggable-handle">
                                <i class="ki ki-menu"></i>
                            </a>
                        </div>
                    </div>
                    <div class="card-body">
                        <img src="@Html.Raw("Upload.Images".AppSetting<string>("/Uploads"))/@item.Widget.ImageUrl" class="img-fluid" />
                    </div>
                </div>
                <!--end::Card-->
            </div>
        }
    }
</div>

@*<div class="card card-custom gutter-b">
        <div class="card-header">
            <div class="card-title">
                <h3 class="card-title align-items-start flex-column">
                    <span class="card-label font-weight-bolder text-dark">Dashboard Widgets</span>
                    <span class="text-muted mt-3 font-weight-bold font-size-sm">Drag the widgets in the order in which you want them to display.</span>
                </h3>
            </div>
        </div>
        <div class="card-body main-body">
            <p>These will display just below the top row tiles.</p>
            <ul id="widgetsSorting" class="widgetsSorting card-group">
                @foreach (var item in Model.MainWidgetSortable.Where(item => item.Widget.IsNotNullOrEmpty()))
                {
                    if (item.Widget.ImageUrl.IsNotNullOrEmpty())
                    {
                        <li id="@item.Widget.Id" data-location="Main" class="kt-portlet card sort-handle">
                            <img src="@Html.Raw("Upload.Images".AppSetting<string>("/Uploads"))/@item.Widget.ImageUrl" class="img-fluid" />
                        </li>
                    }
                    else
                    {
                        if (item.Widget.FileName.IsNotNullOrEmpty())
                        {
                            <li id="@item.Widget.Id" data-location="Main" class="kt-portlet card sort-handle @item.Widget.LayoutSize">
                                <div class="card-header">
                                    <i class="fa fa-align-justify" aria-hidden="true"></i>
                                    <h3 class="card-title font-weight-bolder">@item.Widget.Name</h3>
                                </div>
                                <div class="card-body p-1">
                                    <div data-scroll="true" data-height="300">
                                        @try
                                        {
                                            Html.RenderAction(Path.GetFileNameWithoutExtension(item.Widget.FileName), "Home", new { name = item.Widget.FileName });
                                        }
                                        catch (Exception ex)
                                        {
                                            ExceptionLogger.LogException(ex);
                                            @Html.Partial(item.Widget.FileName.WidgetPartialViewUrl(), mockDashboard)
                                        }
                                    </div>
                                </div>
                            </li>
                        }
                    }
                }
            </ul>
        </div>
    </div>*@
@section belowScripts
{
    <script type="text/javascript">
    $(function () {
        var KTCardDraggable = function () {
            return {
                //main function to initiate the module
                init: function () {
                    var containers = document.querySelectorAll('.draggable-zone');

                    if (containers.length === 0) {
                        return false;
                    }

                    var swappable = new Sortable.default(containers, {
                        draggable: '.draggable',
                        handle: '.draggable-handle',
                        mirror: {
                            appendTo: 'body',
                            constrainDimensions: true
                        }
                    });

                    swappable.on('sortable:stop', function () {
                        var array = [];
                        $('.draggable-zone .draggable').each(function (index) {
                            var id = $(this).attr('id');
                            var location = $(this).data('location');
                            array.push(id + '^' + index + '^' + location);
                        });
                        $.post("/DashboardTemplates/UpdateWidgetSorting", { templateId: '@Model.DashboardTemplate.Id', data: array }, function () {});
                    });
                }
            };
        }();

        jQuery(document).ready(function () {
            KTCardDraggable.init();
        });
    });
    </script>
    <script src="~/Content/assets/plugins/custom/draggable/draggable.bundle.js" type="text/javascript"></script>
}